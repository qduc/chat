# Copilot Instructions for This Repo

## Goal

Help an AI coding agent make small, correct changes that keep OpenAI compatibility and streaming intact.

---

## Architecture (Big Picture)

- **Frontend**: Next.js 15, React 19. Calls backend via `NEXT_PUBLIC_API_BASE` (Compose sets `http://localhost:4001`).
- **Backend**: Express 5, ESM. Exposes OpenAI‑compatible endpoints, proxies to provider, orchestrates server‑side tools, persists conversations (SQLite).
- **Streaming**: SSE end‑to‑end. Backend may stream extra `_conversation` metadata chunks before `data: [DONE]`.

---

## Key Paths to Read/Change First

- **Frontend client & SSE**:
	- `frontend/lib/chat.ts`
	- `frontend/lib/chat/client.ts`
	- Hooks: `frontend/hooks/` (e.g. `useChatStream.ts`)
- **Frontend UI**:
	- `frontend/components/ChatV2.tsx`
	- `MessageList.tsx`
	- `MessageInput.tsx`
- **Backend request flow**:
	- `backend/src/lib/openaiProxy.js` (entry)
	- `streamUtils.js` / `streamingHandler.js` (SSE)
	- `iterativeOrchestrator.js` and `unifiedToolOrchestrator.js` (tools)
	- `simplifiedPersistence.js` (DB)
	- Routes: `backend/src/routes/*`
- **Tools registry**:
	- `backend/src/lib/tools.js` (e.g., `get_time`, `web_search`)

---

## APIs to Preserve (Shapes/Semantics)

- `POST /v1/chat/completions` (primary):
	- OpenAI chat schema
	- Supports: `stream=true`, `tools`, optional `provider_id`, `conversation_id`, `tool_choice`, reasoning controls for supported models
- Streams include:
	- Normal OpenAI chunks
	- Optional `tool_calls` (buffered, consolidated)
	- `tool_output`
	- `_conversation` metadata
	- Always terminate with `data: [DONE]`
- `GET /v1/tools`: Returns tool specs generated from server registry
- Conversations: `GET/POST/DELETE /v1/conversations*` (gated by `config.persistence.enabled`, uses SQLite via `backend/src/db/*`)

---

## Conventions and Invariants (Project‑Specific)

- Never expose provider API keys to the browser. Backend injects `Authorization` using env/provider DB rows.
- Keep OpenAI compatibility at the proxy boundary; don’t break request/response fields or streaming format.
- Frontend relies on `_conversation` events in stream; see `ChatClient.processStreamChunk`.
- Input sanitation: backend maps `systemPrompt` → leading system message (`sanitizeIncomingBody`), accepts `tools` as names or full specs.
- Rate limit all new backend endpoints via `rateLimit` and respect `ALLOWED_ORIGIN` CORS.
- Next.js disables compression for SSE (`frontend/next.config.ts`); don’t re‑enable.

---

## Add a Server‑Side Tool (Example)

1. Edit `backend/src/lib/tools.js`:
	- Provide `validate(args)` and an async `handler`.
	- The OpenAI spec is auto‑generated by `generateOpenAIToolSpecs()`.
	- Example: `web_search` uses Tavily; requires `TAVILY_API_KEY`.
2. Tools are auto-registered and available via both orchestrators:
	- `unifiedToolOrchestrator`: Single turn, consolidated tool calls
	- `iterativeOrchestrator`: Multi-turn with AI thinking between calls

---

## Run, Test, Lint (Use These Exact Commands)

### Local Dev

- **Backend**:
	```sh
	cp backend/.env.example backend/.env && npm --prefix backend install && npm --prefix backend run dev
	```
- **Frontend**:
	```sh
	cp frontend/.env.example frontend/.env.local && npm --prefix frontend install && npm --prefix frontend run dev
	```

### Docker Dev (preferred for full-stack)

- **Quick start**: `./dev.sh up --build` (frontend :3003, backend :4001)
- **Logs**: `./dev.sh logs -f frontend` or `./dev.sh logs -f backend`
- **Shell access**: `./dev.sh exec backend sh` or `./dev.sh exec frontend sh`
- **Database migrations**: `./dev.sh migrate up` (run in backend container)

### Tests & Lint

- ```sh
	npm test                    # run all tests (both frontend & backend)
	npm --prefix backend test   # backend only
	npm --prefix frontend test  # frontend only
	npm run lint               # lint all packages
	```

### Database Operations

- **Migrations**: `npm --prefix backend run migrate` or `./dev.sh migrate up`
- **Test DB setup**: Tests auto-create isolated in-memory DBs via `setupTestDatabase()`

---

## Gotchas (Seen in Code/Tests)

- **Streaming must flush promptly**: use `setupStreamingHeaders` and `writeAndFlush` paths. Never buffer entire responses.
- **When persistence is enabled**, only final assistant content is written (`SimplifiedPersistence`), but deltas still stream to clients.
- **Provider selection** can be passed via body `provider_id` or `x-provider-id` header.
- **Test databases**: Use `setupTestDatabase()` helper - creates isolated in-memory DBs per test.
- **ESM imports**: Backend uses `"type": "module"` - use `import/export`, not `require()`.
- **Next.js compression disabled**: Critical for SSE - see `frontend/next.config.ts`.
- **Tool orchestration modes**: `unifiedToolOrchestrator` (single turn) vs `iterativeOrchestrator` (multi-turn with thinking).

---

## For Deeper Context

See:

- `docs/OVERVIEW.md`
- `docs/API-SPECS.md`
- `docs/SECURITY.md`
- `AI_ONBOARDING.md` (repo root)
